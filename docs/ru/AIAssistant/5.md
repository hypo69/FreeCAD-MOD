# –ß–∞—Å—Ç—å 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò (Ollama, OpenAI –∏ –¥—Ä.)

–¢–µ–ø–µ—Ä—å –≤–∞—à –∞–¥–¥–æ–Ω **AIAssistant** —Å–º–æ–∂–µ—Ç:
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å **—Ç–µ–∫—Å—Ç + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ** –≤ –ª–æ–∫–∞–ª—å–Ω—É—é LLM (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ **Ollama** –∏–ª–∏ **LM Studio**)
- –ü–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
- –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ FreeCAD
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 3D-–º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è

–ú—ã –Ω–∞—á–Ω—ë–º —Å **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ **–ª–æ–∫–∞–ª—å–Ω—ã–µ**, —Ç–∞–∫ –∏ **–æ–±–ª–∞—á–Ω—ã–µ** –º–æ–¥–µ–ª–∏.

---

## üìÅ –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥–¥–æ–Ω–∞

```
AIAssistant/
‚îú‚îÄ‚îÄ Resources/
‚îÇ   ‚îî‚îÄ‚îÄ icons/
‚îÇ       ‚îú‚îÄ‚îÄ ... (–≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–∫–æ–Ω–∫–∏)
‚îÇ       ‚îî‚îÄ‚îÄ ai_chat.svg          ‚Üê –Ω–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞
‚îú‚îÄ‚îÄ InitGui.py
‚îú‚îÄ‚îÄ ai_assistant_workbench.py    ‚Üê –æ–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ project_manager.py
‚îú‚îÄ‚îÄ ai_client.py                 ‚Üê –ù–û–í–´–ô: –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ò–ò
‚îî‚îÄ‚îÄ data/
```

---

## üìÑ 1. `ai_client.py` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ò–ò

–°–æ–∑–¥–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –∞–¥–¥–æ–Ω–∞:

```python
# ai_client.py
import os
import json
import base64
import requests
from pathlib import Path

class AIClient:
    def __init__(self):
        self.provider = "ollama"  # ollama, openai, lmstudio, custom
        self.model = "llava:latest"  # –∏–ª–∏ "gpt-4o", "llama3", –∏ —Ç.–¥.
        self.base_url = "http://localhost:11434"  # –¥–ª—è Ollama
        # –î–ª—è OpenAI: base_url = "https://api.openai.com/v1"
        # API –∫–ª—é—á –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–±—É–¥–µ—Ç –≤ –ß–∞—Å—Ç–∏ 6)

    def encode_image(self, image_path):
        """–ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 (–¥–ª—è OpenAI –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π)"""
        with open(image_path, "rb") as f:
            return base64.b64encode(f.read()).decode("utf-8")

    def send_to_ollama(self, prompt, image_path=None):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ Ollama API"""
        url = f"{self.base_url}/api/generate"
        payload = {
            "model": self.model,
            "prompt": prompt,
            "stream": False
        }
        if image_path and Path(image_path).suffix.lower() in {'.png', '.jpg', '.jpeg'}:
            # Ollama (llava) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ base64 –≤ –ø–æ–ª–µ "images"
            payload["images"] = [self.encode_image(image_path)]

        try:
            response = requests.post(url, json=payload, timeout=120)
            response.raise_for_status()
            return response.json().get("response", "No response")
        except Exception as e:
            return f"Error (Ollama): {str(e)}"

    def send_to_openai(self, prompt, image_path=None):
        """–ü—Ä–∏–º–µ—Ä –¥–ª—è OpenAI (—Ç—Ä–µ–±—É–µ—Ç API-–∫–ª—é—á–∞) ‚Äî —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–∑–∂–µ"""
        return "OpenAI integration not configured yet."

    def ask(self, prompt, image_path=None):
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò"""
        if self.provider == "ollama":
            return self.send_to_ollama(prompt, image_path)
        elif self.provider == "openai":
            return self.send_to_openai(prompt, image_path)
        else:
            return "Unsupported AI provider."

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
ai_client = AIClient()
```

> üí° **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**:  
> - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω **Ollama** (https://ollama.com/)  
> - –ó–∞–ø—É—â–µ–Ω–∞ –º–æ–¥–µ–ª—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:  
>   ```bash
>   ollama pull llava
>   ```

---

## üìÑ 2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `ai_assistant_workbench.py` ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É ¬´Ask AI¬ª

–î–æ–±–∞–≤—å—Ç–µ **–Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É** –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ (–ø–µ—Ä–µ–¥ `FreeCADGui.addCommand`):

```python
# === –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: ASK AI ===
class AskAICommand:
    def GetResources(self):
        icon_path = os.path.join(os.path.dirname(__file__), "Resources", "icons", "ai_chat.svg")
        return {
            "MenuText": "Ask AI",
            "ToolTip": "Send linked image+text to AI model (Ollama required)",
            "Pixmap": icon_path
        }

    def Activated(self):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if project is None or not project.get_all_links():
            QtGui.QMessageBox.information(
                None,
                "No Linked Data",
                "First link an image to a text description using 'Link Content'."
            )
            return

        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —Å–≤—è–∑—å (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ –≤—ã–±–æ—Ä–∞)
        links = project.get_all_links()
        image_file, text_file = next(iter(links.items()))
        image_path = os.path.join(AI_DATA_DIR, image_file)
        text_path = os.path.join(AI_DATA_DIR, text_file)

        # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç
        try:
            with open(text_path, 'r', encoding='utf-8') as f:
                prompt = f.read()
        except Exception as e:
            QtGui.QMessageBox.critical(None, "Error", f"Cannot read text file:\n{str(e)}")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ò–ò
        FreeCAD.Console.PrintMessage("[AIAssistant] Sending request to AI...\n")
        try:
            from AIAssistant.ai_client import ai_client
            response = ai_client.ask(prompt, image_path)
        except Exception as e:
            response = f"AI client error: {str(e)}"

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        dialog = AIResponseDialog(prompt, response)
        dialog.exec_()

    def IsActive(self):
        return True


# === –î–ò–ê–õ–û–ì: –û–¢–í–ï–¢ –û–¢ –ò–ò ===
class AIResponseDialog(QtGui.QDialog):
    def __init__(self, prompt, response):
        super().__init__()
        self.setWindowTitle("AI Assistant ‚Äî Response")
        self.resize(700, 500)

        layout = QtGui.QVBoxLayout()

        # –í–≤–æ–¥ (prompt)
        layout.addWidget(QtGui.QLabel("<b>Your prompt:</b>"))
        prompt_edit = QtGui.QTextEdit()
        prompt_edit.setPlainText(prompt)
        prompt_edit.setReadOnly(True)
        layout.addWidget(prompt_edit)

        # –û—Ç–≤–µ—Ç (response)
        layout.addWidget(QtGui.QLabel("<b>AI Response:</b>"))
        response_edit = QtGui.QTextEdit()
        response_edit.setPlainText(response)
        response_edit.setReadOnly(True)
        layout.addWidget(response_edit)

        # –ö–Ω–æ–ø–∫–∏
        close_btn = QtGui.QPushButton("Close")
        copy_btn = QtGui.QPushButton("Copy Response")
        copy_btn.clicked.connect(lambda: QtGui.QApplication.clipboard().setText(response))
        close_btn.clicked.connect(self.accept)

        btn_layout = QtGui.QHBoxLayout()
        btn_layout.addWidget(copy_btn)
        btn_layout.addStretch()
        btn_layout.addWidget(close_btn)

        layout.addLayout(btn_layout)
        self.setLayout(layout)
```

---

## üñº –ò–∫–æ–Ω–∫–∞ `ai_chat.svg`

```xml
<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
  <path d="M10 50 L20 40 L30 50" fill="none" stroke="black" stroke-width="4"/>
  <path d="M34 40 L44 30 L54 40" fill="none" stroke="black" stroke-width="4"/>
  <circle cx="20" cy="24" r="10" fill="none" stroke="black" stroke-width="4"/>
  <circle cx="44" cy="24" r="10" fill="none" stroke="black" stroke-width="4"/>
</svg>
```

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—Å–≤—è–∑—ã–≤–∞–µ—Ç** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ö–µ–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ)
2. –ù–∞–∂–∏–º–∞–µ—Ç **Ask AI**
3. –ê–¥–¥–æ–Ω:
   - –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ `.md`
   - –ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ **Ollama** (–ª–æ–∫–∞–ª—å–Ω–æ!)
   - –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ–≥–æ –≤ –¥–∏–∞–ª–æ–≥–µ

> üí° **–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞**:  
> –¢–µ–∫—Å—Ç: *"–û–ø–∏—à–∏, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Å—Ö–µ–º–µ, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è 3D-–ø–µ—á–∞—Ç–∏."*  
> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: `housing_design.png`  
> ‚Üí –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º.

---

## ‚öôÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ

1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω **Ollama** (https://ollama.com/)
2. –ó–∞–ø—É—â–µ–Ω–∞ –º–æ–¥–µ–ª—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
   ```bash
   ollama pull llava
   ollama run llava  # (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
   ```
3. Ollama —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:11434`)

> üî∏ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –≤—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ª–æ–∫–∞–ª—å–Ω–æ**, –¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Ö–æ–¥—è—Ç –≤ –æ–±–ª–∞–∫–æ.

---

## üìå –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –ï—Å–ª–∏ **Ollama –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω** ‚Äî –∫–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ —Å–ª–æ–º–∞–µ—Ç –∞–¥–¥–æ–Ω
- –ï—Å–ª–∏ **–Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** ‚Äî –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–Ω–∞—á–∞–ª–∞ —Å–≤—è–∑–∞—Ç—å
- –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∑–∞–≥—Ä—É–∑–∫–∞, —ç–∫—Å–ø–æ—Ä—Ç, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) ‚Äî **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã**

---

## üîú –ß—Ç–æ –±—É–¥–µ—Ç –≤ –ß–∞—Å—Ç–∏ 6?

- –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏, API-–∫–ª—é—á–µ–π, –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **OpenAI**, **Claude**, **LM Studio**
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3D-–∫–æ–¥–∞** –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ –ò–ò (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–æ–±–∫–∏ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤

