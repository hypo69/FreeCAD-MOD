# ðŸ“˜ Cours : CrÃ©ation d'add-ons pour FreeCAD  
## LeÃ§on 5. Enregistrement et chargement des paramÃ¨tres

> **Objectif de la leÃ§on** : faire en sorte que l'add-on Â«Box BuilderÂ» mÃ©morise les derniÃ¨res dimensions saisies et les restaure au prochain dÃ©marrage.

---

## ðŸ’¾ Partie 1. Comment FreeCAD stocke-t-il les paramÃ¨tres ?

FreeCAD fournit un mÃ©canisme intÃ©grÃ© pour stocker les paramÃ¨tres utilisateur â€” via le **Gestionnaire de paramÃ¨tres**.

Il fonctionne avec une **base de paramÃ¨tres hiÃ©rarchique**, similaire au Registre Windows.

### MÃ©thodes principales :

```python
# Obtenir un groupe de paramÃ¨tres
params = FreeCAD.ParamGet("User parameter:BaseApp/Preferences/MyAddon")

# Enregistrer une valeur
params.SetFloat("LastLength", 30.0)
params.SetString("LastName", "MyBox")

# Charger une valeur (avec une valeur par dÃ©faut)
length = params.GetFloat("LastLength", 10.0)  # 10.0 â€” si le paramÃ¨tre n'existe pas
name = params.GetString("LastName", "DefaultBox")
```

> ðŸ’¡ Le chemin `"User parameter:BaseApp/Preferences/..."` â€” est l'emplacement standard pour les paramÃ¨tres utilisateur.

---

## ðŸ›  Partie 2. Add-on mis Ã  jour : Â«Box Builder avec mÃ©moireÂ»

Nous allons modifier l'add-on prÃ©cÃ©dent en ajoutant l'enregistrement et le chargement des derniÃ¨res valeurs.

### Fichier `box_builder_workbench.py` (version mise Ã  jour)

```python
# box_builder_workbench.py
import FreeCAD, FreeCADGui
from PySide import QtGui, QtCore

# === CHEMIN VERS LES PARAMÃˆTRES ===
PARAM_PATH = "User parameter:BaseApp/Preferences/BoxBuilderAddon"

def get_saved_settings():
    """Charge les paramÃ¨tres enregistrÃ©s ou renvoie les valeurs par dÃ©faut"""
    params = FreeCAD.ParamGet(PARAM_PATH)
    return {
        "length": params.GetFloat("LastLength", 30.0),
        "width": params.GetFloat("LastWidth", 20.0),
        "height": params.GetFloat("LastHeight", 10.0),
        "name": params.GetString("LastName", "CustomBox")
    }

def save_settings(length, width, height, name):
    """Enregistre les paramÃ¨tres actuels"""
    params = FreeCAD.ParamGet(PARAM_PATH)
    params.SetFloat("LastLength", length)
    params.SetFloat("LastWidth", width)
    params.SetFloat("LastHeight", height)
    params.SetString("LastName", name)


# === FONCTION DE CRÃ‰ATION DE BOÃŽTE ===
def create_box(length, width, height, name="CustomBox"):
    doc = FreeCAD.ActiveDocument
    if not doc:
        doc = FreeCAD.newDocument("BoxBuilder")
    
    # Nom unique
    base_name = name
    index = 1
    obj_name = base_name
    while obj_name in [obj.Name for obj in doc.Objects]:
        obj_name = f"{base_name}_{index}"
        index += 1

    box = doc.addObject("Part::Box", obj_name)
    box.Length = length
    box.Width = width
    box.Height = height
    doc.recompute()
    return box


# === FENÃŠTRE DE DIALOGUE ===
class BoxBuilderDialog(QtGui.QDialog):
    def __init__(self):
        super(BoxBuilderDialog, self).__init__()
        self.setWindowTitle("Box Builder")
        self.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
        self.resize(300, 180)

        # Charge les paramÃ¨tres enregistrÃ©s
        settings = get_saved_settings()

        # Champs de saisie
        self.length_input = QtGui.QLineEdit(str(settings["length"]))
        self.width_input = QtGui.QLineEdit(str(settings["width"]))
        self.height_input = QtGui.QLineEdit(str(settings["height"]))
        self.name_input = QtGui.QLineEdit(settings["name"])

        # Boutons
        self.create_button = QtGui.QPushButton("Create Box")
        self.cancel_button = QtGui.QPushButton("Cancel")

        # Connexion
        self.create_button.clicked.connect(self.on_create)
        self.cancel_button.clicked.connect(self.reject)

        # Disposition
        layout = QtGui.QFormLayout()
        layout.addRow("Name:", self.name_input)
        layout.addRow("Length (mm):", self.length_input)
        layout.addRow("Width (mm):", self.width_input)
        layout.addRow("Height (mm):", self.height_input)

        button_layout = QtGui.QHBoxLayout()
        button_layout.addWidget(self.create_button)
        button_layout.addWidget(self.cancel_button)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def on_create(self):
        try:
            name = self.name_input.text().strip()
            if not name:
                name = "CustomBox"
                
            length = float(self.length_input.text())
            width = float(self.width_input.text())
            height = float(self.height_input.text())
            
            if length <= 0 or width <= 0 or height <= 0:
                raise ValueError("All dimensions must be positive")
            
            # CrÃ©e l'objet
            create_box(length, width, height, name)
            
            # Enregistre les paramÃ¨tres
            save_settings(length, width, height, name)
            
            self.accept()
            
        except ValueError as e:
            QtGui.QMessageBox.warning(self, "Input Error", f"Invalid input:\n{str(e)}")


# === COMMANDE ET ENVIRONNEMENT DE TRAVAIL (sans changement) ===
class BoxBuilderCommand:
    def GetResources(self):
        return {"MenuText": "Box Builder", "ToolTip": "Create a box with custom dimensions"}
    def Activated(self):
        dialog = BoxBuilderDialog()
        dialog.exec_()
    def IsActive(self):
        return True

class BoxBuilderWorkbench(FreeCADGui.Workbench):
    MenuText = "Box Builder"
    ToolTip = "Create custom boxes with GUI"
    def Initialize(self):
        self.list = ["BoxBuilderCommand"]
        self.appendToolbar("Box Tools", self.list)
        self.appendMenu("Box Builder", self.list)
    def GetClassName(self):
        return "Gui::PythonWorkbench"

FreeCADGui.addCommand("BoxBuilderCommand", BoxBuilderCommand())
```

---

## ðŸ” Ce qui a changÃ© ?

1. **Fonctions ajoutÃ©es** :
   - `get_saved_settings()` â€” charge les derniÃ¨res valeurs
   - `save_settings()` â€” enregistre les valeurs actuelles

2. **Chemin vers les paramÃ¨tres** :
   ```python
   PARAM_PATH = "User parameter:BaseApp/Preferences/BoxBuilderAddon"
   ```
   â†’ Tous les paramÃ¨tres sont stockÃ©s dans un groupe sÃ©parÃ©, sans interfÃ©rer avec d'autres add-ons.

3. **Champ pour le nom** ajoutÃ© Ã  l'interface.

4. **Au dÃ©marrage de la fenÃªtre** â€” les champs sont remplis avec les **valeurs enregistrÃ©es**.

5. **AprÃ¨s la crÃ©ation** â€” les valeurs actuelles sont **enregistrÃ©es automatiquement**.

---

## â–¶ï¸ VÃ©rification du fonctionnement

1. DÃ©marrez FreeCAD
2. Ouvrez **Box Builder**
3. Saisissez, par exemple :
   - Nom : `MyTestBox`
   - Longueur : `50`
   - Largeur : `30`
   - Hauteur : `20`
4. Cliquez sur **Create Box**
5. **Fermez FreeCAD**
6. **RedÃ©marrez**
7. Ouvrez **Box Builder**

âœ… Les champs devraient Ãªtre remplis avec les mÃªmes valeurs !

---

## ðŸ“‚ OÃ¹ sont stockÃ©s ces paramÃ¨tres ?

- **Windows** : dans le registre (`HKEY_CURRENT_USER\SOFTWARE\FreeCAD\...`)
- **Linux/macOS** : dans le fichier `user.cfg` Ã  l'intÃ©rieur du dossier FreeCAD

Mais vous **n'avez pas besoin de le savoir** â€” FreeCAD gÃ¨re le stockage lui-mÃªme.

---

## ðŸ§ª Exercice pratique

1. Ajoutez une **case Ã  cocher** Â«Center on originÂ» et enregistrez son Ã©tat entre les dÃ©marrages.
2. Faites en sorte qu'au premier dÃ©marrage de l'add-on, des **valeurs par dÃ©faut raisonnables** soient utilisÃ©es (dÃ©jÃ  implÃ©mentÃ©).
3. Ajoutez un bouton **Â«Reset to defaultsÂ»**, qui rÃ©initialise les champs aux valeurs par dÃ©faut et efface les paramÃ¨tres enregistrÃ©s.

Indice pour la rÃ©initialisation :
```python
def reset_settings():
    params = FreeCAD.ParamGet(PARAM_PATH)
    params.RemGroup("BoxBuilderAddon")  # Supprime tout le groupe
```

---

## ðŸ’¡ Conseils

- SpÃ©cifiez toujours une **valeur par dÃ©faut** dans `GetFloat()`, `GetString()` etc.
- N'enregistrez pas trop â€” seulement ce qui est rÃ©ellement nÃ©cessaire Ã  l'utilisateur
- Utilisez un **chemin unique** (`BoxBuilderAddon`) pour Ã©viter les conflits avec d'autres add-ons

---

## â–¶ï¸ Et ensuite ?

Dans la **LeÃ§on 6**, nous allons :
- Ajouter des **icÃ´nes** aux boutons et Ã  l'environnement de travail
- Apprendre Ã  utiliser **SVG et PNG** dans l'interface
- Rendre l'add-on visuellement attrayant

```