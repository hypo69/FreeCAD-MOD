# üìò Curso: Creaci√≥n de complementos para FreeCAD  
## Lecci√≥n 5. Guardar y cargar configuraciones

> **Objetivo de la lecci√≥n**: hacer que el complemento ¬´Box Builder¬ª recuerde las √∫ltimas dimensiones introducidas y las restaure en el siguiente inicio.

---

## üíæ Parte 1. ¬øC√≥mo guarda FreeCAD las configuraciones?

FreeCAD proporciona un mecanismo integrado para almacenar par√°metros de usuario ‚Äî a trav√©s del **Administrador de Par√°metros**.

Funciona con una **base de datos de par√°metros jer√°rquica**, similar al Registro de Windows.

### M√©todos principales:

```python
# Obtener un grupo de par√°metros
params = FreeCAD.ParamGet("User parameter:BaseApp/Preferences/MyAddon")

# Guardar valor
params.SetFloat("LastLength", 30.0)
params.SetString("LastName", "MyBox")

# Cargar valor (con valor predeterminado)
length = params.GetFloat("LastLength", 10.0)  # 10.0 ‚Äî si no existe tal par√°metro
name = params.GetString("LastName", "DefaultBox")
```

> üí° La ruta `"User parameter:BaseApp/Preferences/..."` ‚Äî es el lugar est√°ndar para las configuraciones de usuario.

---

## üõ† Parte 2. Complemento actualizado: ¬´Box Builder con memoria¬ª

Modificaremos el complemento anterior, a√±adiendo el guardado y la carga de los √∫ltimos valores.

### Archivo `box_builder_workbench.py` (versi√≥n actualizada)

```python
# box_builder_workbench.py
import FreeCAD, FreeCADGui
from PySide import QtGui, QtCore

# === RUTA A LAS CONFIGURACIONES ===
PARAM_PATH = "User parameter:BaseApp/Preferences/BoxBuilderAddon"

def get_saved_settings():
    """Carga las configuraciones guardadas o devuelve los valores predeterminados"""
    params = FreeCAD.ParamGet(PARAM_PATH)
    return {
        "length": params.GetFloat("LastLength", 30.0),
        "width": params.GetFloat("LastWidth", 20.0),
        "height": params.GetFloat("LastHeight", 10.0),
        "name": params.GetString("LastName", "CustomBox")
    }

def save_settings(length, width, height, name):
    """Guarda las configuraciones actuales"""
    params = FreeCAD.ParamGet(PARAM_PATH)
    params.SetFloat("LastLength", length)
    params.SetFloat("LastWidth", width)
    params.SetFloat("LastHeight", height)
    params.SetString("LastName", name)


# === FUNCI√ìN DE CREACI√ìN DE CAJA ===
def create_box(length, width, height, name="CustomBox"):
    doc = FreeCAD.ActiveDocument
    if not doc:
        doc = FreeCAD.newDocument("BoxBuilder")
    
    # Nombre √∫nico
    base_name = name
    index = 1
    obj_name = base_name
    while obj_name in [obj.Name for obj in doc.Objects]:
        obj_name = f"{base_name}_{index}"
        index += 1

    box = doc.addObject("Part::Box", obj_name)
    box.Length = length
    box.Width = width
    box.Height = height
    doc.recompute()
    return box


# === VENTANA DE DI√ÅLOGO ===
class BoxBuilderDialog(QtGui.QDialog):
    def __init__(self):
        super(BoxBuilderDialog, self).__init__()
        self.setWindowTitle("Box Builder")
        self.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
        self.resize(300, 180)

        # Cargar configuraciones guardadas
        settings = get_saved_settings()

        # Campos de entrada
        self.length_input = QtGui.QLineEdit(str(settings["length"]))
        self.width_input = QtGui.QLineEdit(str(settings["width"]))
        self.height_input = QtGui.QLineEdit(str(settings["height"]))
        self.name_input = QtGui.QLineEdit(settings["name"])

        # Botones
        self.create_button = QtGui.QPushButton("Create Box")
        self.cancel_button = QtGui.QPushButton("Cancel")

        # Conexi√≥n
        self.create_button.clicked.connect(self.on_create)
        self.cancel_button.clicked.connect(self.reject)

        # Dise√±o
        layout = QtGui.QFormLayout()
        layout.addRow("Name:", self.name_input)
        layout.addRow("Length (mm):", self.length_input)
        layout.addRow("Width (mm):", self.width_input)
        layout.addRow("Height (mm):", self.height_input)

        button_layout = QtGui.QHBoxLayout()
        button_layout.addWidget(self.create_button)
        button_layout.addWidget(self.cancel_button)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def on_create(self):
        try:
            name = self.name_input.text().strip()
            if not name:
                name = "CustomBox"
                
            length = float(self.length_input.text())
            width = float(self.width_input.text())
            height = float(self.height_input.text())
            
            if length <= 0 or width <= 0 or height <= 0:
                raise ValueError("All dimensions must be positive")
            
            # Crear objeto
            create_box(length, width, height, name)
            
            # Guardar configuraciones
            save_settings(length, width, height, name)
            
            self.accept()
            
        except ValueError as e:
            QtGui.QMessageBox.warning(self, "Input Error", f"Invalid input:\n{str(e)}")


# === COMANDO Y ENTORNO DE TRABAJO (sin cambios) ===
class BoxBuilderCommand:
    def GetResources(self):
        return {"MenuText": "Box Builder", "ToolTip": "Create a box with custom dimensions"}
    def Activated(self):
        dialog = BoxBuilderDialog()
        dialog.exec_()
    def IsActive(self):
        return True

class BoxBuilderWorkbench(FreeCADGui.Workbench):
    MenuText = "Box Builder"
    ToolTip = "Create custom boxes with GUI"
    def Initialize(self):
        self.list = ["BoxBuilderCommand"]
        self.appendToolbar("Box Tools", self.list)
        self.appendMenu("Box Builder", self.list)
    def GetClassName(self):
        return "Gui::PythonWorkbench"

FreeCADGui.addCommand("BoxBuilderCommand", BoxBuilderCommand())
```

---

## üîç ¬øQu√© ha cambiado?

1. **Funciones a√±adidas**:
   - `get_saved_settings()` ‚Äî carga los √∫ltimos valores
   - `save_settings()` ‚Äî guarda los valores actuales

2. **Ruta a los par√°metros**:
   ```python
   PARAM_PATH = "User parameter:BaseApp/Preferences/BoxBuilderAddon"
   ```
   ‚Üí Todas las configuraciones se almacenan en un grupo separado, sin interferir con otros complementos.

3. **Campo para el nombre** a√±adido a la interfaz.

4. **Al iniciar la ventana** ‚Äî los campos se rellenan con los **valores guardados**.

5. **Despu√©s de la creaci√≥n** ‚Äî los valores actuales se **guardan autom√°ticamente**.

---

## ‚ñ∂Ô∏è Comprobaci√≥n del funcionamiento

1. Inicia FreeCAD
2. Abre **Box Builder**
3. Introduce, por ejemplo:
   - Nombre: `MyTestBox`
   - Longitud: `50`
   - Anchura: `30`
   - Altura: `20`
4. Haz clic en **Create Box**
5. **Cierra FreeCAD**
6. **Inicia de nuevo**
7. Abre **Box Builder**

‚úÖ ¬°Los campos deber√≠an estar rellenos con los mismos valores!

---

## üìÇ ¬øD√≥nde se guardan estas configuraciones?

- **Windows**: en el registro (`HKEY_CURRENT_USER\SOFTWARE\FreeCAD\...`)
- **Linux/macOS**: en el archivo `user.cfg` dentro de la carpeta de FreeCAD

Pero **no necesitas saber esto** ‚Äî FreeCAD gestiona el almacenamiento por s√≠ mismo.

---

## üß™ Tarea pr√°ctica

1. A√±ade una **casilla de verificaci√≥n** ¬´Center on origin¬ª y guarda su estado entre inicios.
2. Haz que en el primer inicio del complemento se utilicen **valores predeterminados razonables** (ya implementado).
3. A√±ade un bot√≥n **¬´Reset to defaults¬ª**, que restablece los campos a los valores predeterminados y borra las configuraciones guardadas.

Sugerencia para restablecer:
```python
def reset_settings():
    params = FreeCAD.ParamGet(PARAM_PATH)
    params.RemGroup("BoxBuilderAddon")  # Elimina todo el grupo
```

---

## üí° Consejos

- Siempre especifica un **valor predeterminado** en `GetFloat()`, `GetString()` etc.
- No guardes demasiado ‚Äî solo lo que el usuario realmente necesita
- Utiliza una **ruta √∫nica** (`BoxBuilderAddon`) para no entrar en conflicto con otros complementos

---

## ‚ñ∂Ô∏è ¬øQu√© sigue?

En la **Lecci√≥n 6** aprenderemos a:
- A√±adir **iconos** a los botones y al entorno de trabajo
- Aprender a usar **SVG y PNG** en la interfaz
- Hacer que el complemento sea visualmente atractivo

```