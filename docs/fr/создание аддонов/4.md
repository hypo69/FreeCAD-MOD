# üìò Cours : Cr√©ation d'add-ons pour FreeCAD  
## Le√ßon 4. Interface graphique (GUI) : bo√Æte de dialogue avec champs de saisie

> **Objectif de la le√ßon** : cr√©er une fen√™tre avec des champs pour saisir la longueur, la largeur et la hauteur, et construire une bo√Æte avec ces param√®tres en cliquant sur un bouton.

---

## üñº Partie 1. Comment fonctionne la GUI dans FreeCAD ?

FreeCAD utilise **PySide** ‚Äî un wrapper Python sur la biblioth√®que **Qt** (la m√™me que dans Blender, Maya et de nombreux autres programmes).

Composants principaux :
- `QtGui.QDialog` ‚Äî fen√™tre modale
- `QtGui.QLineEdit` ‚Äî champ de saisie de texte
- `QtGui.QPushButton` ‚Äî bouton
- `QtGui.QFormLayout` ‚Äî disposition pratique ¬´ √©tiquette + champ ¬ª

> üí° Tous les √©l√©ments de la GUI sont cr√©√©s **√† l'int√©rieur du script Python**, sans fichiers externes (bien que l'on puisse utiliser `.ui` de Qt Designer ‚Äî mais nous commencerons par le plus simple).

---

## üõ† Partie 2. Add-on : ¬´ Box Builder avec GUI ¬ª

Nous allons √©tendre l'add-on pr√©c√©dent en ajoutant une bo√Æte de dialogue.

### √âtape 1. Cr√©ez un dossier

```
.../Mod/BoxBuilderAddon/
```

### √âtape 2. Fichier `InitGui.py`

```python
# InitGui.py
import FreeCADGui
from BoxBuilderAddon.box_builder_workbench import BoxBuilderWorkbench

FreeCADGui.addWorkbench(BoxBuilderWorkbench())
```

### √âtape 3. Fichier `box_builder_workbench.py`

```python
# box_builder_workbench.py
import FreeCAD, FreeCADGui
from PySide import QtGui, QtCore

# === FONCTION DE CR√âATION DE BO√éTE ===
def create_box(length, width, height, name="CustomBox"):
    doc = FreeCAD.ActiveDocument
    if not doc:
        doc = FreeCAD.newDocument("BoxBuilder")
    
    # Nom unique
    base_name = name
    index = 1
    obj_name = base_name
    while obj_name in [obj.Name for obj in doc.Objects]:
        obj_name = f"{base_name}_{index}"
        index += 1

    box = doc.addObject("Part::Box", obj_name)
    box.Length = length
    box.Width = width
    box.Height = height
    doc.recompute()
    return box


# === FEN√äTRE DE DIALOGUE ===
class BoxBuilderDialog(QtGui.QDialog):
    def __init__(self):
        super(BoxBuilderDialog, self).__init__()
        self.setWindowTitle("Box Builder")
        self.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
        self.resize(300, 150)

        # Champs de saisie
        self.length_input = QtGui.QLineEdit("30.0")
        self.width_input = QtGui.QLineEdit("20.0")
        self.height_input = QtGui.QLineEdit("10.0")

        # Boutons
        self.create_button = QtGui.QPushButton("Create Box")
        self.cancel_button = QtGui.QPushButton("Cancel")

        # Connexion des boutons
        self.create_button.clicked.connect(self.on_create)
        self.cancel_button.clicked.connect(self.reject)

        # Disposition
        layout = QtGui.QFormLayout()
        layout.addRow("Length (mm):", self.length_input)
        layout.addRow("Width (mm):", self.width_input)
        layout.addRow("Height (mm):", self.height_input)

        button_layout = QtGui.QHBoxLayout()
        button_layout.addWidget(self.create_button)
        button_layout.addWidget(self.cancel_button)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def on_create(self):
        try:
            length = float(self.length_input.text())
            width = float(self.width_input.text())
            height = float(self.height_input.text())
            
            if length <= 0 or width <= 0 or height <= 0:
                raise ValueError("All dimensions must be positive")
            
            create_box(length, width, height)
            self.accept()  # Fermer la fen√™tre
            
        except ValueError as e:
            QtGui.QMessageBox.warning(self, "Input Error", f"Invalid input:\n{str(e)}")


# === COMMANDE ===
class BoxBuilderCommand:
    def GetResources(self):
        return {
            "MenuText": "Box Builder",
            "ToolTip": "Create a box with custom dimensions"
        }

    def Activated(self):
        dialog = BoxBuilderDialog()
        dialog.exec_()  # Appel modal

    def IsActive(self):
        return True


# === ENVIRONNEMENT DE TRAVAIL ===
class BoxBuilderWorkbench(FreeCADGui.Workbench):
    MenuText = "Box Builder"
    ToolTip = "Create custom boxes with GUI"

    def Initialize(self):
        self.list = ["BoxBuilderCommand"]
        self.appendToolbar("Box Tools", self.list)
        self.appendMenu("Box Builder", self.list)

    def GetClassName(self):
        return "Gui::PythonWorkbench"


FreeCADGui.addCommand("BoxBuilderCommand", BoxBuilderCommand())
```

---

## üîç Analyse des parties cl√©s

### 1. **Fen√™tre de dialogue (`BoxBuilderDialog`)**
- H√©rite de `QtGui.QDialog`
- Utilise `QFormLayout` pour un placement soign√© des champs
- Le bouton **Create Box** appelle `on_create()`, **Cancel** ‚Äî ferme la fen√™tre

### 2. **Traitement de la saisie**
- Convertit le texte en `float`
- V√©rifie que les valeurs sont **positives**
- En cas d'erreur ‚Äî affiche un avertissement via `QMessageBox.warning`

### 3. **Cr√©ation de l'objet**
- La fonction `create_box()` est s√©par√©e ‚Äî pour un code plus propre
- G√©n√®re un nom unique pour √©viter les conflits

### 4. **Lancement de la fen√™tre**
- `dialog.exec_()` ‚Äî rend la fen√™tre **modale** (vous ne pouvez pas interagir avec FreeCAD tant qu'elle est ouverte)

---

## ‚ñ∂Ô∏è √âtape 4. V√©rification du fonctionnement

1. Enregistrez les fichiers
2. Red√©marrez FreeCAD
3. S√©lectionnez l'environnement de travail **¬´ Box Builder ¬ª**
4. Cliquez sur le bouton **¬´ Box Builder ¬ª**
5. Dans la fen√™tre qui appara√Æt, saisissez les dimensions ‚Üí cliquez sur **Create Box**

‚úÖ Une bo√Æte avec vos param√®tres devrait appara√Ætre !

Essayez :
- De saisir des lettres ‚Üí une erreur appara√Ætra
- De saisir un nombre n√©gatif ‚Üí erreur
- De saisir des nombres d√©cimaux (par exemple, `12.5`) ‚Üí cela fonctionne !

---

## üß™ Exercice pratique

1. Ajoutez un **quatri√®me champ** : ¬´ Name ¬ª ‚Äî pour que l'utilisateur puisse d√©finir le nom de l'objet.
2. Faites en sorte que si le nom est vide, la valeur par d√©faut (`"CustomBox"`) soit utilis√©e.
3. Ajoutez une **case √† cocher** ¬´ Center on origin ¬ª ‚Äî si elle est activ√©e, la bo√Æte doit √™tre centr√©e √† l'origine.

> üí° Indice pour le centrage :
> Apr√®s avoir cr√©√© la bo√Æte, modifiez sa propri√©t√© `Placement` :
> ```python
> from FreeCAD import Vector
> box.Placement.Base = Vector(-length/2, -width/2, -height/2)
> ```

---

## üí° Conseils pour travailler avec la GUI

- Enveloppez toujours la saisie dans `try/except` ‚Äî l'utilisateur peut saisir n'importe quoi
- Utilisez `QDoubleValidator` pour n'autoriser que les nombres (facultatif)
- Pour les interfaces complexes, il est pr√©f√©rable d'utiliser **Qt Designer** et de charger des fichiers `.ui`, mais pour les t√¢ches simples ‚Äî le code est plus facile

---

## ‚ñ∂Ô∏è Et ensuite ?

Dans la **Le√ßon 5**, nous allons :
- Apprendre √† **enregistrer les param√®tres** entre les d√©marrages de FreeCAD
- Faire en sorte que la derni√®re valeur de dimension saisie soit **m√©moris√©e**
- Utiliser le m√©canisme int√©gr√© de FreeCAD : `FreeCAD.ParamGet()`

Cela rendra votre add-on encore plus pratique !

