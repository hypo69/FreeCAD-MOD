# üìò Corso di formazione: Creazione di addon per FreeCAD  
## Lezione 4. Interfaccia grafica (GUI): finestra di dialogo con campi di input

> **Obiettivo della lezione**: creare una finestra con campi per l'inserimento di lunghezza, larghezza e altezza, e al clic di un pulsante costruire una scatola con questi parametri.

---

## üñº Parte 1. Come funziona la GUI in FreeCAD?

FreeCAD utilizza **PySide** ‚Äî un wrapper Python per la libreria **Qt** (la stessa usata in Blender, Maya e molti altri programmi).

Componenti principali:
- `QtGui.QDialog` ‚Äî finestra modale
- `QtGui.QLineEdit` ‚Äî campo di input testuale
- `QtGui.QPushButton` ‚Äî pulsante
- `QtGui.QFormLayout` ‚Äî layout comodo "etichetta + campo"

> üí° Tutti gli elementi GUI vengono creati **all'interno dello script Python**, senza file esterni (anche se √® possibile utilizzare `.ui` da Qt Designer ‚Äî ma inizieremo con il semplice).

---

## üõ† Parte 2. Addon: ¬´Box Builder con GUI¬ª

Estenderemo l'addon precedente, aggiungendo una finestra di dialogo.

### Passaggio 1. Crea una cartella

```
.../Mod/BoxBuilderAddon/
```

### Passaggio 2. File `InitGui.py`

```python
# InitGui.py
import FreeCADGui
from BoxBuilderAddon.box_builder_workbench import BoxBuilderWorkbench

FreeCADGui.addWorkbench(BoxBuilderWorkbench())
```

### Passaggio 3. File `box_builder_workbench.py`

```python
# box_builder_workbench.py
import FreeCAD, FreeCADGui
from PySide import QtGui, QtCore

# === FUNZIONE DI CREAZIONE SCATOLA ===
def create_box(length, width, height, name="CustomBox"):
    doc = FreeCAD.ActiveDocument
    if not doc:
        doc = FreeCAD.newDocument("BoxBuilder")
    
    # Nome unico
    base_name = name
    index = 1
    obj_name = base_name
    while obj_name in [obj.Name for obj in doc.Objects]:
        obj_name = f"{base_name}_{index}"
        index += 1

    box = doc.addObject("Part::Box", obj_name)
    box.Length = length
    box.Width = width
    box.Height = height
    doc.recompute()
    return box


# === FINESTRA DI DIALOGO ===
class BoxBuilderDialog(QtGui.QDialog):
    def __init__(self):
        super(BoxBuilderDialog, self).__init__()
        self.setWindowTitle("Box Builder")
        self.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
        self.resize(300, 150)

        # Campi di input
        self.length_input = QtGui.QLineEdit("30.0")
        self.width_input = QtGui.QLineEdit("20.0")
        self.height_input = QtGui.QLineEdit("10.0")

        # Pulsanti
        self.create_button = QtGui.QPushButton("Create Box")
        self.cancel_button = QtGui.QPushButton("Cancel")

        # Connessione dei pulsanti
        self.create_button.clicked.connect(self.on_create)
        self.cancel_button.clicked.connect(self.reject)

        # Layout
        layout = QtGui.QFormLayout()
        layout.addRow("Length (mm):", self.length_input)
        layout.addRow("Width (mm):", self.width_input)
        layout.addRow("Height (mm):", self.height_input)

        button_layout = QtGui.QHBoxLayout()
        button_layout.addWidget(self.create_button)
        button_layout.addWidget(self.cancel_button)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def on_create(self):
        try:
            length = float(self.length_input.text())
            width = float(self.width_input.text())
            height = float(self.height_input.text())
            
            if length <= 0 or width <= 0 or height <= 0:
                raise ValueError("All dimensions must be positive")
            
            create_box(length, width, height)
            self.accept()  # Chiudi la finestra
            
        except ValueError as e:
            QtGui.QMessageBox.warning(self, "Input Error", f"Invalid input:\n{str(e)}")


# === COMANDO ===
class BoxBuilderCommand:
    def GetResources(self):
        return {
            "MenuText": "Box Builder",
            "ToolTip": "Create a box with custom dimensions"
        }

    def Activated(self):
        dialog = BoxBuilderDialog()
        dialog.exec_()  # Chiamata modale

    def IsActive(self):
        return True


# === AMBIENTE DI LAVORO ===
class BoxBuilderWorkbench(FreeCADGui.Workbench):
    MenuText = "Box Builder"
    ToolTip = "Create custom boxes with GUI"

    def Initialize(self):
        self.list = ["BoxBuilderCommand"]
        self.appendToolbar("Box Tools", self.list)
        self.appendMenu("Box Builder", self.list)

    def GetClassName(self):
        return "Gui::PythonWorkbench"


FreeCADGui.addCommand("BoxBuilderCommand", BoxBuilderCommand())
```

---

## üîç Analisi delle parti chiave

### 1. **Finestra di dialogo (`BoxBuilderDialog`)**
- Eredita da `QtGui.QDialog`
- Utilizza `QFormLayout` per un posizionamento ordinato dei campi
- Il pulsante **Create Box** chiama `on_create()`, **Cancel** ‚Äî chiude la finestra

### 2. **Elaborazione dell'input**
- Convertiamo il testo in `float`
- Verifichiamo che i valori siano **positivi**
- In caso di errore ‚Äî mostriamo un avviso tramite `QMessageBox.warning`

### 3. **Creazione dell'oggetto**
- La funzione `create_box()` √® separata ‚Äî per un codice pi√π pulito
- Genera un nome unico per evitare conflitti

### 4. **Avvio della finestra**
- `dialog.exec_()` ‚Äî rende la finestra **modale** (non √® possibile interagire con FreeCAD finch√© √® aperta)

---

## ‚ñ∂Ô∏è Passaggio 4. Verifica del funzionamento

1. Salva i file
2. Riavvia FreeCAD
3. Seleziona l'ambiente di lavoro **¬´Box Builder¬ª**
4. Clicca sul pulsante **¬´Box Builder¬ª**
5. Nella finestra che appare, inserisci le dimensioni ‚Üí clicca su **Create Box**

‚úÖ Dovrebbe apparire una scatola con i tuoi parametri!

Prova a:
- Inserire lettere ‚Üí apparir√† un errore
- Inserire un numero negativo ‚Üí errore
- Inserire numeri decimali (ad esempio, `12.5`) ‚Üí funziona!

---

## üß™ Esercizio pratico

1. Aggiungi un **quarto campo**: ¬´Name¬ª ‚Äî in modo che l'utente possa specificare il nome dell'oggetto.
2. Fai in modo che, se il nome √® vuoto, venga utilizzato un valore predefinito (`"CustomBox"`).
3. Aggiungi una **casella di controllo** ¬´Center on origin¬ª ‚Äî se selezionata, la scatola dovrebbe essere centrata all'origine.

> üí° Suggerimento per la centratura:  
> Dopo aver creato la scatola, modifica la sua propriet√† `Placement`:  
> ```python
> from FreeCAD import Vector
> box.Placement.Base = Vector(-length/2, -width/2, -height/2)
> ```

---

## üí° Consigli per lavorare con la GUI

- Avvolgi sempre l'input in `try/except` ‚Äî l'utente pu√≤ inserire qualsiasi cosa
- Utilizza `QDoubleValidator` per consentire solo numeri (opzionale)
- Per interfacce complesse √® meglio usare **Qt Designer** e caricare file `.ui`, ma per compiti semplici ‚Äî il codice √® pi√π facile

---

## ‚ñ∂Ô∏è Cosa c'√® dopo?

Nella **Lezione 5** impareremo a:
- **Salvare le impostazioni** tra gli avvii di FreeCAD
- Fare in modo che l'ultimo valore delle dimensioni inserito venga **memorizzato**
- Utilizzare il meccanismo integrato di FreeCAD: `FreeCAD.ParamGet()`

Questo render√† il tuo addon ancora pi√π comodo!
