# AIAssistant –ß–∞—Å—Ç—å 4: –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞

–¢–µ–ø–µ—Ä—å –º—ã –¥–æ–±–∞–≤–∏–º **—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç **–ø—Ä–∏–≤—è–∑–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é**, —Å–æ–∑–¥–∞–≤–∞—è –ø–∞—Ä—ã –≤–∏–¥–∞ *¬´—Å—Ö–µ–º–∞ + –ø–æ—è—Å–Ω–µ–Ω–∏–µ¬ª*. –ê —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ–º **—ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –≤ ZIP** ‚Äî —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

---

## üìÅ –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥–¥–æ–Ω–∞

```
AIAssistant/
‚îú‚îÄ‚îÄ Resources/
‚îÇ   ‚îî‚îÄ‚îÄ icons/
‚îÇ       ‚îú‚îÄ‚îÄ ai_assistant.svg
‚îÇ       ‚îú‚îÄ‚îÄ load_image.svg
‚îÇ       ‚îú‚îÄ‚îÄ load_text.svg
‚îÇ       ‚îú‚îÄ‚îÄ manage_content.svg
‚îÇ       ‚îî‚îÄ‚îÄ link_content.svg      ‚Üê –Ω–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞
‚îú‚îÄ‚îÄ InitGui.py
‚îú‚îÄ‚îÄ ai_assistant_workbench.py     ‚Üê –æ–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ project_manager.py            ‚Üê –Ω–æ–≤—ã–π —Ñ–∞–π–ª (–ª–æ–≥–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞)
‚îî‚îÄ‚îÄ data/
    ‚îî‚îÄ‚îÄ project.json              ‚Üê –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

> üí° –ú—ã –≤—ã–Ω–æ—Å–∏–º –ª–æ–≥–∏–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª ‚Äî —Ç–∞–∫ –∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è —á–∏—Å—Ç—ã–º.

---

## üìÑ 1. `project_manager.py` ‚Äî —è–¥—Ä–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º

–°–æ–∑–¥–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ –∞–¥–¥–æ–Ω–∞:

```python
# project_manager.py
import os
import json
from pathlib import Path

AI_DATA_DIR = os.path.join(os.path.expanduser("~"), ".FreeCAD", "AIAssistant", "data")
PROJECT_FILE = os.path.join(AI_DATA_DIR, "project.json")

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
os.makedirs(AI_DATA_DIR, exist_ok=True)

class AIProject:
    def __init__(self):
        self.data = self._load()
    
    def _load(self):
        if os.path.exists(PROJECT_FILE):
            try:
                with open(PROJECT_FILE, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                pass
        return {"links": {}}  # links: {"image.png": "prompt_1.md"}
    
    def save(self):
        with open(PROJECT_FILE, 'w', encoding='utf-8') as f:
            json.dump(self.data, f, indent=2, ensure_ascii=False)
    
    def link_text_to_image(self, image_file, text_file):
        self.data["links"][image_file] = text_file
        self.save()
    
    def unlink_image(self, image_file):
        if image_file in self.data["links"]:
            del self.data["links"][image_file]
            self.save()
    
    def get_linked_text(self, image_file):
        return self.data["links"].get(image_file)
    
    def get_all_links(self):
        return self.data["links"].copy()
    
    def is_image_linked(self, image_file):
        return image_file in self.data["links"]
```

> üí° `project.json` –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∏ ‚Äî —Å–∞–º–∏ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ `data/`.

---

## üìÑ 2. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `ai_assistant_workbench.py`

–ú—ã –¥–æ–±–∞–≤–∏–º:
- –ù–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É **¬´Link Content¬ª**
- –ö–Ω–æ–ø–∫–∏ **¬´Link¬ª / ¬´Unlink¬ª** –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ –≤ ZIP

```python
# ai_assistant_workbench.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
import FreeCAD, FreeCADGui
import os
import shutil
import zipfile
from pathlib import Path
from PySide import QtGui, QtCore

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
from AIAssistant.project_manager import AIProject

AI_DATA_DIR = os.path.join(FreeCAD.getUserAppDataDir(), "AIAssistant", "data")
os.makedirs(AI_DATA_DIR, exist_ok=True)
project = AIProject()  # –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä

# ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ LoadImageCommand, LoadTextCommand –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

# === –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: LINK CONTENT ===
class LinkContentCommand:
    def GetResources(self):
        icon_path = os.path.join(os.path.dirname(__file__), "Resources", "icons", "link_content.svg")
        return {
            "MenuText": "Link Content",
            "ToolTip": "Link a text description to an image",
            "Pixmap": icon_path
        }
    def Activated(self):
        dialog = LinkContentDialog()
        dialog.exec_()
    def IsActive(self):
        return True

# === –î–ò–ê–õ–û–ì: –°–í–Ø–ó–´–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ù–¢–ê ===
class LinkContentDialog(QtGui.QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Link Image and Text")
        self.resize(500, 400)

        # –°–ø–∏—Å–∫–∏
        self.image_list = QtGui.QListWidget()
        self.text_list = QtGui.QListWidget()

        self.refresh_lists()

        # –ö–Ω–æ–ø–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
        self.link_btn = QtGui.QPushButton("‚Üí Link Selected")
        self.link_btn.clicked.connect(self.link_selected)

        # –†–∞—Å–∫–ª–∞–¥–∫–∞
        layout = QtGui.QHBoxLayout()
        layout.addWidget(QtGui.QLabel("Images:"))
        layout.addWidget(self.image_list)
        layout.addWidget(self.link_btn)
        layout.addWidget(QtGui.QLabel("Texts:"))
        layout.addWidget(self.text_list)

        btn_layout = QtGui.QHBoxLayout()
        close_btn = QtGui.QPushButton("Close")
        close_btn.clicked.connect(self.accept)
        btn_layout.addStretch()
        btn_layout.addWidget(close_btn)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(btn_layout)
        self.setLayout(main_layout)

    def refresh_lists(self):
        self.image_list.clear()
        self.text_list.clear()
        for f in sorted([f for f in os.listdir(AI_DATA_DIR) if Path(f).suffix.lower() in {'.png','.jpg','.jpeg','.bmp','.svg','.gif'}]):
            item = QtGui.QListWidgetItem(f)
            if project.is_image_linked(f):
                item.setForeground(QtGui.QColor("green"))
            self.image_list.addItem(item)
        for f in sorted([f for f in os.listdir(AI_DATA_DIR) if Path(f).suffix.lower() in {'.txt','.md'}]):
            self.text_list.addItem(f)

    def link_selected(self):
        image_items = self.image_list.selectedItems()
        text_items = self.text_list.selectedItems()
        if not image_items or not text_items:
            QtGui.QMessageBox.warning(self, "Selection", "Select one image and one text file.")
            return
        image_file = image_items[0].text()
        text_file = text_items[0].text()
        project.link_text_to_image(image_file, text_file)
        FreeCAD.Console.PrintMessage(f"[AIAssistant] Linked: {image_file} ‚Üî {text_file}\n")
        self.refresh_lists()

# === –û–ë–ù–û–í–õ–Å–ù–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† –ö–û–ù–¢–ï–ù–¢–ê ===
# (–≤ –∫–ª–∞—Å—Å–µ ContentManagerDialog –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫–∏ Link/Unlink –≤ image_tab)

# –í –º–µ—Ç–æ–¥–µ create_image_tab –∑–∞–º–µ–Ω–∏—Ç–µ –±–ª–æ–∫ btn_layout –Ω–∞:
def create_image_tab(self):
    widget = QtGui.QWidget()
    layout = QtGui.QVBoxLayout()

    self.image_list = QtGui.QListWidget()
    self.image_list.setSelectionMode(QtGui.QAbstractItemView.SingleSelection)
    self.refresh_image_list()

    btn_layout = QtGui.QHBoxLayout()
    self.link_btn = QtGui.QPushButton("Link to Text")
    self.unlink_btn = QtGui.QPushButton("Unlink")
    self.link_btn.clicked.connect(self.link_image)
    self.unlink_btn.clicked.connect(self.unlink_image)
    btn_layout.addWidget(self.link_btn)
    btn_layout.addWidget(self.unlink_btn)
    btn_layout.addStretch()

    layout.addWidget(self.image_list)
    layout.addLayout(btn_layout)
    widget.setLayout(layout)
    return widget

# –ò –¥–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥—ã –≤ ContentManagerDialog:
def link_image(self):
    items = self.image_list.selectedItems()
    if not items:
        return
    image_file = items[0].text()
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    text_files = get_text_files()
    if not text_files:
        QtGui.QMessageBox.information(self, "No Texts", "No text files available.")
        return
    text_file, ok = QtGui.QInputDialog.getItem(self, "Link Text", "Select text file:", text_files, 0, False)
    if ok and text_file:
        project.link_text_to_image(image_file, text_file)
        FreeCAD.Console.PrintMessage(f"[AIAssistant] Linked: {image_file} ‚Üî {text_file}\n")
        self.refresh_image_list()

def unlink_image(self):
    items = self.image_list.selectedItems()
    if not items:
        return
    image_file = items[0].text()
    if project.is_image_linked(image_file):
        project.unlink_image(image_file)
        FreeCAD.Console.PrintMessage(f"[AIAssistant] Unlinked: {image_file}\n")
        self.refresh_image_list()

def refresh_image_list(self):
    self.image_list.clear()
    for f in get_image_files():
        item = QtGui.QListWidgetItem(f)
        if project.is_image_linked(f):
            item.setForeground(QtGui.QColor("green"))
        self.image_list.addItem(item)

# === –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: EXPORT PROJECT ===
class ExportProjectCommand:
    def GetResources(self):
        return {"MenuText": "Export Project", "ToolTip": "Export all data as ZIP archive"}
    def Activated(self):
        zip_path, _ = QtGui.QFileDialog.getSaveFileName(None, "Save Project ZIP", "", "ZIP Files (*.zip)")
        if not zip_path:
            return
        if not zip_path.endswith(".zip"):
            zip_path += ".zip"
        try:
            with zipfile.ZipFile(zip_path, 'w') as zf:
                for root, dirs, files in os.walk(AI_DATA_DIR):
                    for file in files:
                        full_path = os.path.join(root, file)
                        arc_path = os.path.relpath(full_path, os.path.dirname(AI_DATA_DIR))
                        zf.write(full_path, arc_path)
            QtGui.QMessageBox.information(None, "Success", f"Project exported to:\n{zip_path}")
        except Exception as e:
            QtGui.QMessageBox.critical(None, "Error", f"Export failed:\n{str(e)}")
    def IsActive(self): return True

# === –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –°–†–ï–î–ê ===
class AIAssistantWorkbench(FreeCADGui.Workbench):
    MenuText = "AI Assistant"
    ToolTip = "AI design assistant with content linking"

    def __init__(self):
        self.Icon = os.path.join(os.path.dirname(__file__), "Resources", "icons", "ai_assistant.svg")

    def Initialize(self):
        self.list = [
            "LoadImageCommand",
            "LoadTextCommand",
            "LinkContentCommand",
            "ManageContentCommand",
            "ExportProjectCommand"
        ]
        self.appendToolbar("AI Tools", self.list)
        self.appendMenu("AI Assistant", self.list)

    def GetClassName(self):
        return "Gui::PythonWorkbench"

# === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–û–í–´–• –ö–û–ú–ê–ù–î ===
FreeCADGui.addCommand("LinkContentCommand", LinkContentCommand())
FreeCADGui.addCommand("ExportProjectCommand", ExportProjectCommand())
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ...
```

---

## üñº –ò–∫–æ–Ω–∫–∞ `link_content.svg`

```xml
<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
  <circle cx="20" cy="32" r="12" fill="none" stroke="black" stroke-width="4"/>
  <circle cx="44" cy="32" r="12" fill="none" stroke="black" stroke-width="4"/>
  <line x1="32" y1="32" x2="36" y2="32" stroke="black" stroke-width="4"/>
  <line x1="28" y1="32" x2="24" y2="32" stroke="black" stroke-width="4"/>
</svg>
```

---

## üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –°–≤—è–∑—ã–≤–∞–Ω–∏–µ:
- –í **Manage Content ‚Üí Images** ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Üí **Link to Text** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `.md` —Ñ–∞–π–ª
- –°–≤—è–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è **–∑–µ–ª—ë–Ω—ã–º**
- –°–≤—è–∑–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `project.json`

### –≠–∫—Å–ø–æ—Ä—Ç:
- **Export Project** ‚Üí —Å–æ–∑–¥–∞—ë—Ç ZIP-–∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º `AIAssistant/data/`
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–ª–ª–µ–≥–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é

---

## üìÅ –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ (`project.zip`):

```
AIAssistant/
‚îî‚îÄ‚îÄ data/
    ‚îú‚îÄ‚îÄ diagram.svg
    ‚îú‚îÄ‚îÄ ai_prompt_1.md
    ‚îî‚îÄ‚îÄ project.json   ‚Üê {"links": {"diagram.svg": "ai_prompt_1.md"}}
```

---

## üîú –ß—Ç–æ –±—É–¥–µ—Ç –≤ –ß–∞—Å—Ç–∏ 5?

- **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤—è–∑–∫–∏**: –∫–ª–∏–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM**: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞—Ä—ã (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + —Ç–µ–∫—Å—Ç) –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å (Ollama, LM Studio) –∏–ª–∏ API (OpenAI, Claude)
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3D-–º–æ–¥–µ–ª–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è

---

–ì–æ—Ç–æ–≤—ã –∫ –ß–∞—Å—Ç–∏ 5 ‚Äî **–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º**? –ù–∞–ø–∏—à–∏—Ç–µ **¬´–î–∞¬ª**! ü§ñ