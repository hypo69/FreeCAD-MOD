# üìò Curso: Creaci√≥n de complementos para FreeCAD  
## Lecci√≥n 4. Interfaz gr√°fica de usuario (GUI): cuadro de di√°logo con campos de entrada

> **Objetivo de la lecci√≥n**: crear una ventana con campos para introducir la longitud, la anchura y la altura, y al pulsar un bot√≥n construir una caja con esos par√°metros.

---

## üñº Parte 1. ¬øC√≥mo funciona la GUI en FreeCAD?

FreeCAD utiliza **PySide**, un envoltorio de Python sobre la biblioteca **Qt** (la misma que se usa en Blender, Maya y muchos otros programas).

Componentes principales:
- `QtGui.QDialog` ‚Äî ventana modal
- `QtGui.QLineEdit` ‚Äî campo de entrada de texto
- `QtGui.QPushButton` ‚Äî bot√≥n
- `QtGui.QFormLayout` ‚Äî dise√±o c√≥modo de ¬´etiqueta + campo¬ª

> üí° Todos los elementos de la GUI se crean **dentro del script de Python**, sin archivos externos (aunque se puede usar `.ui` de Qt Designer, pero empezaremos con algo sencillo).

---

## üõ† Parte 2. Complemento: ¬´Box Builder con GUI¬ª

Ampliaremos el complemento anterior a√±adiendo un cuadro de di√°logo.

### Paso 1. Crea una carpeta

```
.../Mod/BoxBuilderAddon/
```

### Paso 2. Archivo `InitGui.py`

```python
# InitGui.py
import FreeCADGui
from BoxBuilderAddon.box_builder_workbench import BoxBuilderWorkbench

FreeCADGui.addWorkbench(BoxBuilderWorkbench())
```

### Paso 3. Archivo `box_builder_workbench.py`

```python
# box_builder_workbench.py
import FreeCAD, FreeCADGui
from PySide import QtGui, QtCore

# === FUNCI√ìN DE CREACI√ìN DE CAJA ===
def create_box(length, width, height, name="CustomBox"):
    doc = FreeCAD.ActiveDocument
    if not doc:
        doc = FreeCAD.newDocument("BoxBuilder")
    
    # Nombre √∫nico
    base_name = name
    index = 1
    obj_name = base_name
    while obj_name in [obj.Name for obj in doc.Objects]:
        obj_name = f"{base_name}_{index}"
        index += 1

    box = doc.addObject("Part::Box", obj_name)
    box.Length = length
    box.Width = width
    box.Height = height
    doc.recompute()
    return box


# === CUADRO DE DI√ÅLOGO ===
class BoxBuilderDialog(QtGui.QDialog):
    def __init__(self):
        super(BoxBuilderDialog, self).__init__()
        self.setWindowTitle("Box Builder")
        self.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)
        self.resize(300, 150)

        # Campos de entrada
        self.length_input = QtGui.QLineEdit("30.0")
        self.width_input = QtGui.QLineEdit("20.0")
        self.height_input = QtGui.QLineEdit("10.0")

        # Botones
        self.create_button = QtGui.QPushButton("Create Box")
        self.cancel_button = QtGui.QPushButton("Cancel")

        # Conexi√≥n de botones
        self.create_button.clicked.connect(self.on_create)
        self.cancel_button.clicked.connect(self.reject)

        # Dise√±o
        layout = QtGui.QFormLayout()
        layout.addRow("Length (mm):", self.length_input)
        layout.addRow("Width (mm):", self.width_input)
        layout.addRow("Height (mm):", self.height_input)

        button_layout = QtGui.QHBoxLayout()
        button_layout.addWidget(self.create_button)
        button_layout.addWidget(self.cancel_button)

        main_layout = QtGui.QVBoxLayout()
        main_layout.addLayout(layout)
        main_layout.addLayout(button_layout)
        self.setLayout(main_layout)

    def on_create(self):
        try:
            length = float(self.length_input.text())
            width = float(self.width_input.text())
            height = float(self.height_input.text())
            
            if length <= 0 or width <= 0 or height <= 0:
                raise ValueError("All dimensions must be positive")
            
            create_box(length, width, height)
            self.accept()  # Cerrar ventana
            
        except ValueError as e:
            QtGui.QMessageBox.warning(self, "Input Error", f"Invalid input:\n{str(e)}")


# === COMANDO ===
class BoxBuilderCommand:
    def GetResources(self):
        return {
            "MenuText": "Box Builder",
            "ToolTip": "Create a box with custom dimensions"
        }

    def Activated(self):
        dialog = BoxBuilderDialog()
        dialog.exec_()  # Llamada modal

    def IsActive(self):
        return True


# === ENTORNO DE TRABAJO ===
class BoxBuilderWorkbench(FreeCADGui.Workbench):
    MenuText = "Box Builder"
    ToolTip = "Create custom boxes with GUI"

    def Initialize(self):
        self.list = ["BoxBuilderCommand"]
        self.appendToolbar("Box Tools", self.list)
        self.appendMenu("Box Builder", self.list)

    def GetClassName(self):
        return "Gui::PythonWorkbench"


FreeCADGui.addCommand("BoxBuilderCommand", BoxBuilderCommand())
```

---

## üîç Desglose de las partes clave

### 1. **Cuadro de di√°logo (`BoxBuilderDialog`)**
- Hereda de `QtGui.QDialog`
- Utiliza `QFormLayout` para una colocaci√≥n ordenada de los campos
- El bot√≥n **Create Box** llama a `on_create()`, **Cancel** ‚Äî cierra la ventana

### 2. **Procesamiento de la entrada**
- Convertimos el texto a `float`
- Comprobamos que los valores sean **positivos**
- En caso de error ‚Äî mostramos una advertencia a trav√©s de `QMessageBox.warning`

### 3. **Creaci√≥n del objeto**
- La funci√≥n `create_box()` se ha extra√≠do por separado ‚Äî para un c√≥digo m√°s limpio
- Genera un nombre √∫nico para evitar conflictos

### 4. **Lanzamiento de la ventana**
- `dialog.exec_()` ‚Äî hace que la ventana sea **modal** (no se puede interactuar con FreeCAD mientras est√© abierta)

---

## ‚ñ∂Ô∏è Paso 4. Comprobaci√≥n del funcionamiento

1. Guarda los archivos
2. Reinicia FreeCAD
3. Selecciona el entorno de trabajo **¬´Box Builder¬ª**
4. Haz clic en el bot√≥n **¬´Box Builder¬ª**
5. En la ventana que aparece, introduce las dimensiones ‚Üí haz clic en **Create Box**

‚úÖ ¬°Deber√≠a aparecer una caja con tus par√°metros!

Prueba a:
- Introducir letras ‚Üí aparecer√° un error
- Introducir un n√∫mero negativo ‚Üí error
- Introducir n√∫meros decimales (por ejemplo, `12.5`) ‚Üí ¬°funciona!

---

## üß™ Tarea pr√°ctica

1. A√±ade un **cuarto campo**: ¬´Name¬ª ‚Äî para que el usuario pueda establecer el nombre del objeto.
2. Haz que si el nombre est√° vac√≠o, se utilice el valor predeterminado (`"CustomBox"`).
3. A√±ade una **casilla de verificaci√≥n** ¬´Center on origin¬ª ‚Äî si est√° activada, la caja debe estar centrada en el origen.

> üí° Sugerencia para centrar:
> Despu√©s de crear la caja, cambia su propiedad `Placement`:
> ```python
> from FreeCAD import Vector
> box.Placement.Base = Vector(-length/2, -width/2, -height/2)
> ```

---

## üí° Consejos para trabajar con la GUI

- Envuelve siempre la entrada en `try/except` ‚Äî el usuario puede introducir cualquier cosa
- Utiliza `QDoubleValidator` para permitir solo n√∫meros (opcional)
- Para interfaces complejas, es mejor usar **Qt Designer** y cargar archivos `.ui`, pero para tareas sencillas ‚Äî el c√≥digo es m√°s f√°cil

---

## ‚ñ∂Ô∏è ¬øQu√© sigue?

En la **Lecci√≥n 5** aprenderemos a:
- **Guardar configuraciones** entre inicios de FreeCAD
- Hacer que el √∫ltimo valor de las dimensiones introducidas se **recuerde**
- Utilizar el mecanismo integrado de FreeCAD: `FreeCAD.ParamGet()`

¬°Esto har√° que tu complemento sea a√∫n m√°s c√≥modo!
